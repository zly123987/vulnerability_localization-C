import csv
import os
import pymongo

def get_data():
    mongo_connection = pymongo.MongoClient('159.138.98.160',
                port =8635,
                username='rwuser',
                password='Sc@ntist123',
                authSource='admin',
                authMechanism='SCRAM-SHA-256')
    vul_function_list = mongo_connection['patch-collection']['vul-function-list']
    cve_mapping = mongo_connection['patch-collection']['cve-mapping']
    repo = mongo_connection['patch-collection']['lib-repo-mapping']
    print(cve_mapping.count_documents({}))
    with open('data/xxx.csv', 'w') as f:
        writer = csv.writer(f)
        for doc in cve_mapping.find({'platform': 'Maven'}):
            cve = doc['CVE_id']
            if 'website_patch_dict' in doc:
                patch = list(doc['website_patch_dict'].keys())
                if 'vul_tag_list' not in doc:
                    continue
                affected_version  = doc['vul_tag_list']
                lib  = doc['lib_name']
                repo_link = ''
                repo_name = ''
                d = repo.find_one({'lib_name': lib})
                if d:
                    repo_link = d['repo_link']
                    repo_name = repo_link.split('/')[-1]
                for p in patch:
                    d = vul_function_list.find_one({'patch_link': p})
                    if d:
                        func_dict = d['func_dict']
                        clsses = []
                        methods = []
                        for key, value in func_dict.items():
                            clzz = key.split('/')[-1].replace('.java', '')
                            clsses.append(clzz)
                            for met in value:
                                methods.append(clzz+':'+met)
                        if len(clsses)>0:
                            patch_link = p
                            writer.writerow([cve, repo_link, patch_link, repo_name, '|'.join(affected_version), '|'.join(clsses), '|'.join(methods)])


def clone_repos():
    l = ['https://github.com/spring-projects/spring-framework', 'https://github.com/apache/cxf', 'https://github.com/jeremyh/jBCrypt', 'https://github.com/apache/cxf', 'https://github.com/apache/activemq', 'https://github.com/ngallagher/simplexml', 'https://github.com/pastelmind/snakeyaml', 'https://github.com/apache/cxf', 'https://github.com/apache/zookeeper', 'https://github.com/apache/activemq', 'https://github.com/apache/velocity-tools', 'https://github.com/junit-team/junit4', 'https://github.com/resteasy/Resteasy', 'https://github.com/apache/groovy', 'https://github.com/apache/netbeans-html4j', 'https://github.com/apache/commons-configuration', 'https://github.com/apache/druid', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/x-stream/xstream', 'https://github.com/x-stream/xstream', 'https://github.com/x-stream/xstream', 'https://github.com/undertow-io/undertow', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/googleapis/google-oauth-java-client', 'https://github.com/google/guava', 'https://github.com/FasterXML/jackson-databind', 'https://github.com/netty/netty', 'https://github.com/netty/netty', 'https://github.com/apache/druid', 'https://github.com/netplex/json-smart-v2', 'https://github.com/netty/netty', 'https://github.com/x-stream/xstream', 'https://github.com/apache/logging-log4j2', 'https://github.com/apache/logging-log4j2', 'https://github.com/junrar/junrar', 'https://github.com/opencast/opencast', 'https://github.com/opencast/opencast', 'https://github.com/opencast/opencast', 'https://github.com/dropwizard/dropwizard', 'https://github.com/jooby-project/jooby', 'https://github.com/ratpack/ratpack', 'https://github.com/hapifhir/hapi-fhir', 'https://github.com/xjodoin/torpedoquery', 'https://github.com/apache/cxf-fediz', 'https://github.com/eclipse/rdf4j', 'https://github.com/Wechat-Group/weixin-java-tools', 'https://github.com/vert-x3/vertx-web', 'https://github.com/vert-x3/vertx-web', 'https://github.com/vert-x3/vertx-web', 'https://github.com/inversoft/prime-jwt', 'https://github.com/inversoft/prime-jwt', 'https://github.com/dashbuilder/dashbuilder', 'https://github.com/orientechnologies/orientdb', 'https://github.com/Jasig/cas', 'https://github.com/spring-projects/spring-framework', 'https://github.com/spring-projects/spring-framework', 'https://github.com/ESAPI/esapi-java-legacy', 'https://github.com/apache/cxf-fediz', 'https://github.com/apache/cxf-fediz', 'https://github.com/apache/deltaspike', 'https://github.com/apache/karaf', 'https://github.com/apache/juddi', 'https://github.com/liferay/liferay-portal', 'https://github.com/jbossas/jboss-as', 'https://github.com/jbossas/jboss-as', 'https://github.com/jruby/jruby', 'https://github.com/fusesource/hawtjni', 'https://github.com/spring-projects/spring-framework', 'https://github.com/seam2/jboss-seam', 'https://github.com/seam2/jboss-seam', 'https://github.com/rhuss/jolokia', 'https://github.com/netty/netty', 'https://github.com/keycloak/keycloak', 'https://github.com/elastic/elasticsearch', 'https://github.com/undertow-io/undertow', 'https://github.com/elastic/elasticsearch', 'https://github.com/elastic/elasticsearch', 'https://github.com/bcgit/bc-java', 'https://github.com/bcgit/bc-java', 'https://github.com/apache/struts1', 'https://github.com/apache/struts1', 'https://github.com/spring-projects/spring-amqp', 'https://github.com/FasterXML/jackson-dataformat-xml', 'https://github.com/eclipse/jetty.project', 'https://github.com/apache/tika', 'https://github.com/undertow-io/undertow', 'https://github.com/FasterXML/jackson-dataformat-xml']

    os.chdir('../../maven_repos/')
    for each in l:
        os.system('git clone '+each)


# clone_repos()